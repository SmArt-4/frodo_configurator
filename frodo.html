<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="google" content="notranslate">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Frodo Configurator</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#007bff">
    <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js')
                .then(() => console.log('Service Worker Registered (Offline Capable)'))
                .catch((error) => console.log('SW Registration Failed:', error));
        }
    </script>
    <style>
        :root {
            /* Light theme defaults */
            --bg-color: #f7f7f9;
            --panel-bg: #ffffff;
            --border-color: #d9d9e0;
            --highlight: #007bff;
            --text-color: #1f2328;
            --muted-bg: #eef0f3;
            --muted-fg: #57606a;
            --frame-bg: #fafafa;
            --frame-border: #d0d7de;
            --ruler-tick: #8c959f;
            --ruler-text: #6e7781;
            --baseline-color: #d8dee4;
            --vtx1-color: #007bff; /* Blue */
            --vtx2-color: #28a745; /* Green */
            --error-color: #dc3545;
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --bg-color: #0d1117;
                --panel-bg: #161b22;
                --border-color: #30363d;
                --highlight: #2f81f7;
                --text-color: #e6edf3;
                --muted-bg: #1f242d;
                --muted-fg: #9ea7b3;
                --frame-bg: #11161d;
                --frame-border: #30363d;
                --ruler-tick: #6e7681;
                --ruler-text: #9ea7b3;
                --baseline-color: #2d333b;
            }
        }

        html[data-theme="light"] {
            --bg-color: #f7f7f9;
            --panel-bg: #ffffff;
            --border-color: #d9d9e0;
            --highlight: #007bff;
            --text-color: #1f2328;
            --muted-bg: #eef0f3;
            --muted-fg: #57606a;
            --frame-bg: #fafafa;
            --frame-border: #d0d7de;
            --ruler-tick: #8c959f;
            --ruler-text: #6e7781;
            --baseline-color: #d8dee4;
        }
        html[data-theme="dark"] {
            --bg-color: #0d1117;
            --panel-bg: #161b22;
            --border-color: #30363d;
            --highlight: #2f81f7;
            --text-color: #e6edf3;
            --muted-bg: #1f242d;
            --muted-fg: #9ea7b3;
            --frame-bg: #11161d;
            --frame-border: #30363d;
            --ruler-tick: #6e7681;
            --ruler-text: #9ea7b3;
            --baseline-color: #2d333b;
        }

        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
            background: var(--bg-color); 
            color: var(--text-color); 
            margin: 0 auto; 
            padding: 20px; 
            max-width: 900px; 
        }
        
        /* HEADER */
        .header {
            display: flex; flex-direction: row; justify-content: space-between; align-items: center;
            gap: 15px; background: var(--panel-bg); padding: 10px 15px; 
            border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-bottom: 20px;
            flex-wrap: nowrap;
        }
        
        .header-group { display: flex; align-items: center; gap: 10px; }
        
        label { font-weight: 600; font-size: 14px; margin-right: 5px; white-space: nowrap; }
        
        .commit-hash {
            font-family: monospace; background: var(--muted-bg); padding: 6px 8px; 
            border-radius: 6px; border: 1px solid var(--border-color); color: var(--muted-fg); font-size: 13px;
        }

        /* INPUTS & BUTTONS */
        select, input[type="text"], input[type="number"] {
            padding: 6px 8px; border: 1px solid var(--border-color); border-radius: 4px; font-size: 14px;
        }
        
        button {
            padding: 8px 16px; border: none; border-radius: 4px; font-weight: 600; cursor: pointer; transition: 0.2s;
            font-size: 14px; white-space: nowrap;
        }
        #connectBtn { background-color: var(--highlight); color: white; }
        #connectBtn.connected { background-color: #28a745; }

        .btn-green { background-color: #28a745; color: #fff; }
        .btn-blue { background-color: var(--highlight); color: #fff; }
        .text-right { text-align: right; }

        /* Split Button */
        .split { position: relative; display: inline-flex; --caret-w: 36px; }
        .btn-main { border-radius: 4px 0 0 4px; }
        .btn-caret {
            border-radius: 0 4px 4px 0; padding: 8px 10px; width: var(--caret-w);
            display: flex; align-items: center; justify-content: center;
            border-left: 1px solid rgba(255,255,255,0.6);
        }
        .dropdown-row {
            position: absolute; top: calc(100% + 6px); left: 0;
            min-width: calc(100% - var(--caret-w)); width: max-content;
            display: none; z-index: 20;
        }
        .dropdown-row.show { display: block; }
        .dropdown-row .btn-blue {
            border-radius: 4px; padding: 8px 12px; white-space: nowrap; display: block;
            box-shadow: 0 3px 8px rgba(0,0,0,0.08); margin-bottom: 6px;
        }
        .dropdown-row .btn-blue:last-child { margin-bottom: 0; }

        /* HARMONICS MODAL (intrmd integrated) */
        .harm-row { display:flex; align-items: center; gap: 10px; margin: 6px 0; }
        .harm-row label { width: 180px; color: var(--muted-fg); font-weight: 600; }
        .harm-inputs { display:flex; gap:10px; }
        .harm-columns { display:flex; gap: 12px; margin-top: 8px; }
        .harm-col { flex:1; background: var(--muted-bg); border: 1px solid var(--border-color); border-radius: 8px; padding: 10px; min-height: 160px; }
        .harm-col h3 { margin: 0 8px 0 0; font-size: 11px; color: var(--muted-fg); text-transform: uppercase; letter-spacing: 0.5px; }
        .harm-col-header { display:flex; align-items: flex-end; gap: 8px; margin-bottom: 8px; }
        .harm-item { background: var(--panel-bg); padding: 8px; margin-bottom: 8px; border-radius: 6px; border: 1px solid var(--border-color); display:flex; justify-content: space-between; align-items:center; position:relative; cursor:pointer; }
        .harm-item.active { border-color: var(--highlight); box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .harm-del {
            display: none;
            position: absolute; right: -8px; top: -8px;
            background: #dc3545; color: #fff; border: none; border-radius: 50%;
            width: 20px; height: 20px; padding: 0;
            font-size: 14px; line-height: 20px; text-align: center; cursor: pointer;
            display: none; align-items: center; justify-content: center;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        }
        .harm-item:hover .harm-del { display: flex; }
        .harm-del:focus { outline: none; box-shadow: 0 0 0 2px rgba(220,53,69,0.35); }
        .harm-del:hover { filter: brightness(0.95); transform: translateY(-1px); }
        .harm-results { margin-top: 12px; padding: 10px; border-radius: 8px; background: var(--panel-bg); border: 1px solid var(--border-color); display:none; }
        .harm-res-row { margin-bottom: 10px; padding: 8px; border: 1px solid var(--border-color); border-radius: 6px; }
        .harm-im { display:inline-block; padding:6px; margin:4px; border-radius:4px; font-size:12px; border-left:4px solid; min-width:200px; vertical-align: top; }
        .harm-order3 { background: #fff5f5; border-color: #e74c3c; }
        .harm-order2 { background: #f0f9ff; border-color: #3498db; }
        .harm-harmonic { background: #fffaf0; border-color: #fd7e14; }
        .harm-raw { background: #111; color:#0f0; padding: 10px; border-radius: 6px; font-family: monospace; font-size: 12px; min-height: 40px; word-break: break-all; }

        /* Dark theme readability for Harmonics IM mix results */
        html[data-theme="dark"] .harm-order3 { background: rgba(231, 76, 60, 0.16); border-color: #e74c3c; color: var(--text-color); }
        html[data-theme="dark"] .harm-order2 { background: rgba(52, 152, 219, 0.16); border-color: #3498db; color: var(--text-color); }
        html[data-theme="dark"] .harm-harmonic { background: rgba(253, 126, 20, 0.16); border-color: #fd7e14; color: var(--text-color); }

        @media (prefers-color-scheme: dark) {
            :root:not([data-theme]) .harm-order3 { background: rgba(231, 76, 60, 0.16); border-color: #e74c3c; color: var(--text-color); }
            :root:not([data-theme]) .harm-order2 { background: rgba(52, 152, 219, 0.16); border-color: #3498db; color: var(--text-color); }
            :root:not([data-theme]) .harm-harmonic { background: rgba(253, 126, 20, 0.16); border-color: #fd7e14; color: var(--text-color); }
        }
        
        /* SETTINGS GRID */
        .settings-block {
            border: 2px solid var(--border-color); background: var(--panel-bg);
            padding: 25px 20px 20px 20px; border-radius: 5px; margin-bottom: 20px; position: relative;
        }
        .settings-block h3 {
            position: absolute; top: -12px; left: 15px; background: var(--panel-bg);
            padding: 0 10px; margin: 0; color: #555; font-size: 16px;
        }

        .settings-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 40px; }
        @media (max-width: 600px) {
            .settings-grid { grid-template-columns: 1fr; gap: 10px; }
            .header { overflow-x: auto; }
        }
        
        /* FORM ROWS */
        .form-row { 
            display: flex; 
            flex-direction: row; 
            align-items: center; 
            margin-bottom: 12px; 
        }
        .form-row label { 
            width: 120px; 
            margin-bottom: 0; 
            flex-shrink: 0; 
            font-size: 13px; color: #666; 
        }
        .form-row input, .form-row select { 
            flex-grow: 1; 
            width: auto;
        }

        /* Input suffix (e.g., 'ms') */
        .input-with-suffix { position: relative; flex-grow: 1; display: flex; }
        .input-with-suffix input { padding-right: 32px; width: 100%; }
        .input-with-suffix .suffix { position: absolute; right: 8px; top: 50%; transform: translateY(-50%); color: var(--muted-fg); font-size: 13px; pointer-events: none; }
        /* Compact variant for small numeric cells (e.g., VRX range) */
        .input-with-suffix.compact { display: inline-flex; flex-grow: 0; }
        .input-with-suffix.compact input { width: 80px; }

        /* FREQ BLOCK */
        .freq-block { padding: 10px 0; position: relative; }
        .freq-block h3 { margin: 0 0 15px 0; color: #555; font-size: 16px; border-bottom: 1px solid #eee; display: inline-block;}
        .range-inputs { display: flex; align-items: center; gap: 10px; flex-grow: 1; }
        .range-inputs input { width: 40px; text-align: center; }
        /* Ensure VRX inputs with suffix have enough width */
        .range-inputs .input-with-suffix.compact input { width: 80px; }

        /* Harmonics header input widths */
        .input-with-suffix.compact input.harm-5ch { width: calc(5ch + 16px); }
        .input-with-suffix.compact input.harm-3ch { width: calc(3ch + 16px); }

        /* VISUALIZER CANVAS */
        .viz-container {
            position: relative; 
            width: 95%; 
            margin: 15px auto 25px auto; 
            height: 70px; /* Taller to fit text below */
            background: transparent; /* No background here, we draw it in canvas */
            border: none; /* Remove HTML border */
            border-radius: 0; 
            cursor: crosshair;
        }
        canvas { display: block; width: 100%; height: 100%; }

        /* POPUP */
        .freq-popup {
            position: absolute; background: var(--panel-bg); border: 1px solid var(--border-color); border-radius: 4px;
            padding: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.25);
            z-index: 100; display: none; transform: translate(-50%, -100%); margin-top: -10px;
            text-align: center; min-width: 120px; color: var(--text-color);
        }
        .freq-popup::after { 
            content: ""; position: absolute; top: 100%; left: 50%; margin-left: -6px;
            border-width: 6px; border-style: solid; border-color: var(--panel-bg) transparent transparent transparent;
        }
        .freq-popup::before { 
            content: ""; position: absolute; top: 100%; left: 50%; margin-left: -7px;
            border-width: 7px; border-style: solid; border-color: var(--border-color) transparent transparent transparent; z-index: -1;
        }
        .freq-label { font-weight: bold; margin-bottom: 5px; font-size: 14px; display: block; }
        .popup-btns { display: flex; gap: 5px; justify-content: center; }
        .btn-mini { padding: 4px 8px; font-size: 11px; border-radius: 3px; border: none; cursor: pointer; color: white;}
        .btn-vtx1 { background-color: var(--vtx1-color); opacity: 0.5; }
        .btn-vtx1.active { opacity: 1; border: 2px solid #004085; }
        .btn-vtx2 { background-color: var(--vtx2-color); opacity: 0.5; }
        .btn-vtx2.active { opacity: 1; border: 2px solid #1e7e34; }

        /* RANDOM GENERATOR POPUP */
        .overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.35); display: none; z-index: 200;
        }
        .overlay.show { display: block; }
        .rand-popup {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: var(--panel-bg); border: 1px solid var(--border-color); border-radius: 8px; width: min(560px, 95vw);
            box-shadow: 0 10px 30px rgba(0,0,0,0.25); z-index: 201; display: none; color: var(--text-color);
        }
        .rand-popup.show { display: block; }
        .rand-header { padding: 12px 14px; font-weight: 700; border-bottom: 1px solid var(--border-color); display:flex; justify-content: space-between; align-items:center; color: var(--text-color); }
        .rand-body { padding: 12px 14px; display: grid; gap: 10px; color: var(--text-color); }
        .rand-row { display: flex; align-items: center; gap: 10px; }
        .rand-row label { width: 160px; color: var(--muted-fg); font-weight: 600; }
        .rand-row .grow { flex: 1; }
        .rand-footer { padding: 12px 14px; border-top: 1px solid var(--border-color); display: flex; gap: 8px; justify-content: flex-end; }
        .rand-textarea { width: 100%; min-height: 56px; resize: vertical; font-family: monospace; font-size: 12px; background: var(--panel-bg); color: var(--text-color); border: 1px solid var(--border-color); }

        /* Help modal text/readability */
        .rand-body p { margin: 0 0 8px 0; color: var(--text-color); }
        .rand-body details { border: 1px solid var(--border-color); border-radius: 6px; background: var(--panel-bg); }
        .rand-body details + details { margin-top: 8px; }
        .rand-body details[open] { background: var(--panel-bg); }
        .rand-body summary { list-style: none; cursor: pointer; padding: 10px 12px; color: var(--text-color); }
        .rand-body summary::-webkit-details-marker { display: none; }
        .rand-body summary:before { content: '▸'; display: inline-block; margin-right: 6px; transform: rotate(0deg); transition: transform 0.15s ease; color: var(--muted-fg); }
        .rand-body details[open] > summary:before { transform: rotate(90deg); }
        .rand-body code { background: var(--muted-bg); color: var(--text-color); border: 1px solid var(--border-color); padding: 0 4px; border-radius: 4px; }

        /* Help intro card */
        .help-intro { border: 1px solid var(--border-color); border-radius: 6px; background: var(--panel-bg); padding: 10px 12px; margin-bottom: 10px; }
        .help-intro h4 { margin: 0 0 6px 0; font-size: 14px; }
        .help-intro ul { margin: 6px 0 0 18px; padding: 0; }
        .help-intro li { margin: 4px 0; }
        .help-intro .note { font-size: 12px; color: var(--muted-fg); margin-top: 6px; }

        /* Match VRX range cell look for randCount */
        #randCount { width: 80px; text-align: center; }

        /* Override inline close button color in header for theme */
        .rand-header button {
            background: var(--muted-bg) !important;
            color: var(--text-color);
            border: 1px solid var(--border-color);
        }

        /* VTX RICH INPUT STYLES */
        .vtx-wrapper { position: relative; flex-grow: 1; display: flex; }
        
        .vtx-input { 
            display: none; width: 100%; 
            box-sizing: border-box; padding: 6px 8px; 
            border: 1px solid var(--border-color); border-radius: 4px; 
            font-size: 14px; margin: 0; height: 35px;
        } 
        .vtx-input.active { display: block; }
        
        .vtx-display {
            width: 100%; box-sizing: border-box;
            padding: 6px 8px; border: 1px solid var(--border-color); border-radius: 4px; 
            font-size: 14px; background: #fff; min-height: 35px; 
            display: flex; flex-wrap: wrap; gap: 5px; align-items: center; cursor: text;
        }
        .vtx-display.hidden { display: none; }
        
        .freq-tag { color: #333; }
        .freq-tag.out-range { 
            color: var(--error-color); 
            text-decoration: underline; text-decoration-thickness: 2px; font-weight: bold;
        }
        .freq-tag.placeholder { color: #aaa; font-style: italic; }

        /* LOG WINDOW */
        #debugLog {
            margin-top: 20px; font-family: monospace; font-size: 11px; color: var(--muted-fg);
            height: 100px; overflow-y: scroll; border: 1px solid var(--border-color); background: var(--panel-bg); padding: 10px;
        }

        /* Theme toggle */
        .theme-toggle {
            position: fixed; top: 10px; right: 10px; z-index: 500;
            background: var(--panel-bg); color: var(--text-color);
            border: 1px solid var(--border-color); border-radius: 6px; padding: 6px 10px; font-size: 12px;
        }
    </style>
</head>
<body>

    <button id="themeToggle" class="theme-toggle" title="Theme">Auto</button>

    <div class="header">
        <div class="header-group header-left">
            <div style="display:flex; align-items:center;">
                <label style="width: auto;">Role:</label>
                <select id="roleSelect">
                    <option value="1">Air unit (1)</option>
                    <option value="0">Ground unit (0)</option>
                </select>
            </div>
            <div class="commit-hash" id="commitHash">Commit: ---</div>
            <button id="readBtn" class="btn-blue">Read FULL config</button>
        </div>

        <div class="header-group header-right">
            <button id="connectBtn">Connect</button>
            <div class="split" id="writeSplit">
                <button id="writeBtn" class="btn-green btn-main">Write</button>
                <button id="writeCaretBtn" class="btn-green btn-caret">▾</button>
                <div id="resetRow" class="dropdown-row">
                    <button id="resetBtn" class="btn-blue text-right">Reset to default</button>
                </div>
            </div>
            <button id="helpBtn" class="btn-blue" title="Help" style="padding:6px 10px; border-radius:50%; width:34px; height:34px; display:inline-flex; align-items:center; justify-content:center;">?</button>
        </div>
    </div>

    <div class="settings-block">
        <h3>Frodo settings</h3>
        <div class="settings-grid">
            <div class="col-aux">
                <div class="form-row">
                    <label>Sync_AUX:</label>
                    <select id="syncAuxSelect"></select>
                </div>
                <div class="form-row">
                    <label>Start/Stop AUX:</label>
                    <select id="stopAuxSelect"></select>
                </div>
            </div>
            <div class="col-time">
                <div class="form-row">
                    <label>Switch_latency:</label>
                    <div class="input-with-suffix">
                        <input type="text" id="swLatencyInput" value="150">
                        <span class="suffix">ms</span>
                    </div>
                </div>
                <div class="form-row">
                    <label>Time on freq:</label>
                    <div class="input-with-suffix">
                        <input type="text" id="txTimeInput" value="2000">
                        <span class="suffix">ms</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="freq-block">
        <h3>Freq settings</h3>
        
        <div class="form-row" style="max-width: 600px; gap: 10px;">
            <label>VRX range:</label>
            <div class="range-inputs">
                <div class="input-with-suffix compact">
                    <input type="number" id="vrxMin" value="4200">
                    <span class="suffix">MHz</span>
                </div>
                <span>-</span>
                <div class="input-with-suffix compact">
                    <input type="number" id="vrxMax" value="4900">
                    <span class="suffix">MHz</span>
                </div>
            </div>
            <button id="randBtn" class="btn-blue" style="margin-left:auto;">Random</button>
            <button id="harmBtn" class="btn-blue">Harmonics</button>
        </div>

        <div class="viz-container" id="vizContainer">
            <canvas id="freqCanvas"></canvas>
            <div class="freq-popup" id="freqPopup">
                <span class="freq-label" id="popupLabel">0000</span>
                <div class="popup-btns">
                    <button class="btn-mini btn-vtx1" id="popupVtx1">VTX1</button>
                    <button class="btn-mini btn-vtx2" id="popupVtx2">VTX2</button>
                </div>
            </div>
        </div>

        <div class="form-row">
            <label>VTX1:</label>
            <div class="vtx-wrapper">
                <div class="vtx-display" id="vtx1Display"></div>
                <input type="text" class="vtx-input" id="vtx1Input" placeholder="4200 4250...">
            </div>
        </div>
        <div class="form-row">
            <label>VTX2:</label>
            <div class="vtx-wrapper">
                <div class="vtx-display" id="vtx2Display"></div>
                <input type="text" class="vtx-input" id="vtx2Input" placeholder="4200 4250...">
            </div>
        </div>
    </div>

    <div id="debugLog">Ready. Connect Frodo board first!</div>

    <details id="cliPanel" style="margin-top: 12px;">
        <summary style="cursor:pointer; font-weight:600;">CLI commands</summary>
        <textarea id="cliTextarea" style="width:100%; height:120px; margin-top:8px; box-sizing:border-box; font-family:monospace; font-size:12px;"></textarea>
    </details>

    <script>
        // DOM Elements
        const connectBtn = document.getElementById('connectBtn');
        const commitHashLabel = document.getElementById('commitHash');
        const debugLog = document.getElementById('debugLog');
        const roleSelect = document.getElementById('roleSelect');
        const syncAuxSelect = document.getElementById('syncAuxSelect');
        const stopAuxSelect = document.getElementById('stopAuxSelect');
        const swLatencyInput = document.getElementById('swLatencyInput');
        const txTimeInput = document.getElementById('txTimeInput');
        
        const vrxMinInput = document.getElementById('vrxMin');
        const vrxMaxInput = document.getElementById('vrxMax');
        const randBtn = document.getElementById('randBtn');
        const harmBtn = document.getElementById('harmBtn');
        
        // VTX Rich Inputs
        const vtx1Input = document.getElementById('vtx1Input');
        const vtx1Display = document.getElementById('vtx1Display');
        const vtx2Input = document.getElementById('vtx2Input');
        const vtx2Display = document.getElementById('vtx2Display');

        // Split button elements
        const writeBtn = document.getElementById('writeBtn');
        const writeCaretBtn = document.getElementById('writeCaretBtn');
        const writeSplit = document.getElementById('writeSplit');
        const resetRow = document.getElementById('resetRow');
        const resetBtn = document.getElementById('resetBtn');
        const readBtn = document.getElementById('readBtn');
        
        // Visualizer Elements
        const vizContainer = document.getElementById('vizContainer');
        const canvas = document.getElementById('freqCanvas');
        const ctx = canvas.getContext('2d');
        const freqPopup = document.getElementById('freqPopup');
        const popupLabel = document.getElementById('popupLabel');
        const popupVtx1 = document.getElementById('popupVtx1');
        const popupVtx2 = document.getElementById('popupVtx2');
        const helpBtn = document.getElementById('helpBtn');

        // Random Generator Popup Elements (created dynamically)
        let randPopup, randOverlay, randModeAdd, randModeReplace, randExcl, randCount, randTargetV1, randTargetV2, randTargetBoth, randFillBtn, randCloseBtn;
        let helpOverlay, helpPopup, helpCloseBtn;
        // Harmonics modal elements
        let harmOverlay, harmPopup;
        let hRangeStart, hRangeEnd, hCol1, hCol2, hCol3, hCol1Items, hCol2Items, hCol3Items, hResults, hRaw;
        let hC1Freq, hC1Bw, hC2Freq, hC2Bw, hC3Freq, hC3Bw;
        let hLists = [[], [], []];
        let roleConfirmOverlay, roleConfirmPopup, roleConfirmText, roleConfirmYes, roleConfirmCancel, roleConfirmDontAsk;
        let suppressRoleChangeConfirm = false;

        // Logic Variables
        let port, writerStream, reader;
        let isConnected = false;
        let vtx1Freqs = [];
        let vtx2Freqs = [];
        let isPopupOpen = false;
        let selectedFreq = 0;

        // Init
        initAuxDropdowns();
        resizeCanvas();
        updateVtxDisplay(1);
        updateVtxDisplay(2);
        window.addEventListener('resize', resizeCanvas);
        initTheme();

        // --- 1. POPULATE AUX ---
        function initAuxDropdowns() {
            const auxOptions = [];
            for (let i = 4; i <= 15; i++) {
                // Keep sending original numeric values (4..15), but display as Ch5..Ch16
                const display = `Ch${i + 1}`;
                auxOptions.push(`<option value="${i}">${display}</option>`);
            }
            syncAuxSelect.innerHTML = auxOptions.join('');
            stopAuxSelect.innerHTML = auxOptions.join('');

            // Set defaults: Sync = Ch6 (value 5), Stop = Ch8 (value 7)
            try { syncAuxSelect.value = '5'; } catch(_) {}
            try { stopAuxSelect.value = '7'; } catch(_) {}
            updateAuxDisables();
        }

        // Ensure AUX selectors are not equal
        function auxValues() { const arr = []; for (let i = 4; i <= 15; i++) arr.push(String(i)); return arr; }
        function pickAlternative(taken) {
            const arr = auxValues();
            const idx = arr.indexOf(String(taken));
            if (idx === -1) return arr[0];
            // pick next available (wrap)
            for (let k = 1; k < arr.length; k++) {
                const cand = arr[(idx + k) % arr.length];
                if (cand !== String(taken)) return cand;
            }
            return arr[0];
        }
        function setDisabledExceptSelected(selectEl, valueToDisable) {
            const disableVal = String(valueToDisable);
            for (const opt of selectEl.options) {
                if (opt.value === disableVal && opt.value !== selectEl.value) opt.disabled = true; else opt.disabled = false;
            }
        }
        function updateAuxDisables() {
            setDisabledExceptSelected(syncAuxSelect, stopAuxSelect.value);
            setDisabledExceptSelected(stopAuxSelect, syncAuxSelect.value);
        }
        function ensureAuxDistinct(changed) {
            const syncVal = syncAuxSelect.value;
            const stopVal = stopAuxSelect.value;
            if (syncVal && stopVal && syncVal === stopVal) {
                if (changed === 'sync') {
                    stopAuxSelect.value = pickAlternative(syncVal);
                } else {
                    syncAuxSelect.value = pickAlternative(stopVal);
                }
            }
            updateAuxDisables();
        }

        // --- 2. CONNECT ---
        connectBtn.addEventListener('click', async () => {
            if (!navigator.serial) return alert("Web Serial API not supported.");
            try {
                port = await navigator.serial.requestPort({ 
                    filters: [
                        { usbVendorId: 0x0483 }, { usbVendorId: 0x10C4 }, 
                        { usbVendorId: 0x0403 }, { usbVendorId: 0x1A86 }, { usbVendorId: 0x2341 }
                    ] 
                });
                await port.open({ baudRate: 9600 });
                await port.setSignals({ dataTerminalReady: true, requestToSend: true });
                writerStream = port.writable.getWriter();
                
                connectBtn.textContent = "Connected";
                connectBtn.classList.add("connected");
                connectBtn.disabled = true;
                isConnected = true;

                readLoop();
                runStartupSequence();
            } catch (err) {
                log(`Error: ${err.message}`);
            }
        });

        // Enforce distinct AUX selections on change
        syncAuxSelect.addEventListener('change', () => { ensureAuxDistinct('sync'); maybeUpdateCli(); });
        stopAuxSelect.addEventListener('change', () => { ensureAuxDistinct('stop'); maybeUpdateCli(); });

        // Graceful cleanup and UI reset on disconnect/errors
        async function cleanupPort() {
            try { if (reader) { try { await reader.cancel(); } catch(_){} try { reader.releaseLock(); } catch(_){} reader = null; } } catch(_){}
            try { if (writerStream) { writerStream.releaseLock(); writerStream = null; } } catch(_){}
            try { if (port) { await port.close(); } } catch(_){}
        }

        function setDisconnectedUI(msg) {
            if (msg) log(msg);
            connectBtn.textContent = 'Connect';
            connectBtn.classList.remove('connected');
            connectBtn.disabled = false;
            isConnected = false;
        }

        if (navigator.serial) {
            navigator.serial.addEventListener('disconnect', async (event) => {
                // If the disconnected port is the one we used, clean up
                if (!port || (event.port && port !== event.port)) {
                    log('A serial device disconnected');
                    return;
                }
                await cleanupPort();
                setDisconnectedUI('Device disconnected');
            });
            navigator.serial.addEventListener('connect', () => {
                log('Serial device connected');
            });
        }

        // --- 3. WRITE ---
        writeBtn.addEventListener('click', async () => {
            if (!port || !writerStream) return alert("Not connected!");
            writeBtn.disabled = true; document.body.style.cursor = 'wait';
            
            try {
                const commands = getCommandsForWrite();
                // Check for role change before write
                const roleCmd = commands.find(c => /^set_role\s+\d+/.test(c));
                if (roleCmd && !suppressRoleChangeConfirm) {
                    const desiredRoleMatch = roleCmd.match(/^set_role\s+(\d+)/);
                    const desiredRole = desiredRoleMatch ? parseInt(desiredRoleMatch[1], 10) : null;
                    if (desiredRole !== null) {
                        const proceed = await ensureRoleChangeOk(desiredRole);
                        if (!proceed) { writeBtn.disabled = false; document.body.style.cursor = 'default'; return; }
                    }
                }
                for (const cmd of commands) {
                    await sendCommandAndWait(cmd);
                }
                alert("Settings saved!");
            } catch (e) { log(`Write Error: ${e}`); }
            finally { writeBtn.disabled = false; document.body.style.cursor = 'default'; }
        });

        // --- 4. STARTUP SEQUENCE ---
        async function runStartupSequence() {
            log("--- Reading Commit ---");
            let helpData = await sendCommandAndWait("help");
            if (!parseCommit(helpData)) {
                await new Promise(r => setTimeout(r, 400));
                helpData = await sendCommandAndWait("help");
                parseCommit(helpData);
            }
            log("Tip: Use Read to load settings");
        }

        async function readAllSettings() {
            if (!port || !writerStream) return alert("Not connected!");
            log("--- Reading Settings ---");
            try {
                parseValue(await sendCommandAndWait("set_role"), roleSelect, "Role");
                parseValue(await sendCommandAndWait("set_sync_rc_channel"), syncAuxSelect, "Sync_AUX");
                parseValue(await sendCommandAndWait("set_stop_rc_channel"), stopAuxSelect, "Stop_AUX");
                parseValue(await sendCommandAndWait("set_sw_latency"), swLatencyInput, "Latency");
                parseValue(await sendCommandAndWait("set_tx_time"), txTimeInput, "TX Time");
                parseVtxList(await sendCommandAndWait("set_vtx1_freq"), 1);
                parseVtxList(await sendCommandAndWait("set_vtx2_freq"), 2);
                log("--- Done ---");
                drawViz();
                updateAuxDisables();
                updateCliTextarea();
            } catch (e) { log(`Read Error: ${e}`); }
        }

        // --- 5. PARSERS & UI UPDATE ---
        function parseCommit(text) {
            const match = text.match(/Commit\s+([0-9a-fA-F]+)/);
            if (match && match[1]) {
                commitHashLabel.textContent = `Commit: ${match[1].substring(0, 7)}`;
                return true;
            } return false;
        }

        function parseValue(text, element, label) {
            const matches = text.match(/(\d+)/g);
            if (matches && matches.length > 0) {
                element.value = matches[matches.length - 1];
                log(`Parsed ${label}: ${element.value}`);
            }
        }

        function parseVtxList(text, vtxNum) {
            const match = text.match(/frequencies \d+;\s*([\d\s]+)/);
            if (match && match[1]) {
                const list = match[1].trim().split(/\s+/).map(Number);
                if (vtxNum === 1) { vtx1Freqs = list; } 
                else { vtx2Freqs = list; }
                updateVtxDisplay(vtxNum);
                log(`Parsed VTX${vtxNum} List: [${list.length} items]`);
            }
        }

        // --- 6. RICH VTX DISPLAY LOGIC ---
        function updateVtxDisplay(vtxNum) {
            const list = (vtxNum === 1) ? vtx1Freqs : vtx2Freqs;
            const display = (vtxNum === 1) ? vtx1Display : vtx2Display;
            const input = (vtxNum === 1) ? vtx1Input : vtx2Input;
            const min = parseInt(vrxMinInput.value) || 0;
            const max = parseInt(vrxMaxInput.value) || 9999;

            input.value = list.join(' ');
            display.innerHTML = '';
            if(list.length === 0) {
                display.innerHTML = '<span class="freq-tag placeholder">Empty... click to edit</span>';
            } else {
                list.forEach(f => {
                    const span = document.createElement('span');
                    span.textContent = f;
                    span.className = 'freq-tag';
                    if (f < min || f > max) {
                        span.classList.add('out-range');
                        span.title = "Out of VRX Range";
                    }
                    display.appendChild(span);
                });
            }
        }

        function setupVtxSwap(display, input, vtxNum) {
            display.addEventListener('click', () => {
                display.classList.add('hidden');
                input.classList.add('active');
                input.focus();
            });

            input.addEventListener('blur', () => {
                const raw = input.value.trim();
                const newList = raw ? raw.split(/\s+/).map(Number).filter(n => !isNaN(n)) : [];
                if(vtxNum === 1) vtx1Freqs = newList;
                else vtx2Freqs = newList;
                updateVtxDisplay(vtxNum);
                display.classList.remove('hidden');
                input.classList.remove('active');
                drawViz();
                updateCliTextarea();
            });
        }
        setupVtxSwap(vtx1Display, vtx1Input, 1);
        setupVtxSwap(vtx2Display, vtx2Input, 2);

        function checkRanges() {
            updateVtxDisplay(1);
            updateVtxDisplay(2);
            drawViz();
            updateCliTextarea();
        }
        vrxMinInput.addEventListener('input', checkRanges);
        vrxMaxInput.addEventListener('input', checkRanges);

        // --- 7. COMMS (Faster Timings) ---
        let currentResponseBuffer = "";
        async function sendCommandAndWait(cmd) {
            currentResponseBuffer = ""; 
            await sendSlow(cmd);
            await new Promise(r => setTimeout(r, 300)); 
            return currentResponseBuffer;
        }
        async function sendSlow(cmd) {
            log(`> Sending: ${cmd}`);
            const encoder = new TextEncoder();
            for (let i = 0; i < cmd.length; i++) {
                await writerStream.write(encoder.encode(cmd[i]));
                await new Promise(r => setTimeout(r, 10)); 
            }
            await writerStream.write(encoder.encode("\r"));
        }
        async function readLoop() {
            reader = port.readable.getReader();
            const decoder = new TextDecoder();
            try {
                while (true) {
                    const { value, done } = await reader.read();
                    if (done) break;
                    if (value) currentResponseBuffer += decoder.decode(value, { stream: true });
                }
            } catch (e) {
                console.error(e);
                await cleanupPort();
                setDisconnectedUI('Serial read stopped');
            } finally {
                try { reader.releaseLock(); } catch(_){}
            }
        }
        function log(msg) {
            const line = document.createElement('div');
            line.textContent = msg;
            debugLog.appendChild(line);
            debugLog.scrollTop = debugLog.scrollHeight;
        }

        // --- 8. VISUALIZER & RULER ---
        function resizeCanvas() {
            // Handle High-DPI for crisp ruler
            const dpr = window.devicePixelRatio || 1;
            const rect = vizContainer.getBoundingClientRect();
            
            canvas.width = rect.width * dpr;
            canvas.height = rect.height * dpr;
            
            ctx.scale(dpr, dpr);
            drawViz();
        }

        function drawViz() {
            const rect = vizContainer.getBoundingClientRect();
            const w = rect.width;
            const h = rect.height;

            // Layout Dimensions
            const frameH = 40; // Height of the "Frame" (Bar area)
            const textY = 54;  // Y position for text

            // Clear canvas
            ctx.clearRect(0, 0, w, h);

            const min = parseInt(vrxMinInput.value) || 4200;
            const max = parseInt(vrxMaxInput.value) || 4900;
            const range = max - min;
            
            // 1. Draw The "Visualisation Frame" (Background & Border)
            const cssVars = getComputedStyle(document.documentElement);
            const frameBg = cssVars.getPropertyValue('--frame-bg').trim() || '#fafafa';
            const frameBorder = cssVars.getPropertyValue('--frame-border').trim() || '#ccc';
            const rulerTick = cssVars.getPropertyValue('--ruler-tick').trim() || '#999';
            const rulerText = cssVars.getPropertyValue('--ruler-text').trim() || '#666';
            const baselineColor = cssVars.getPropertyValue('--baseline-color').trim() || '#ddd';

            ctx.fillStyle = frameBg;
            ctx.fillRect(0, 0, w, frameH);
            
            ctx.strokeStyle = frameBorder;
            ctx.lineWidth = 1;
            ctx.strokeRect(0, 0, w, frameH);

            // 2. Draw Ruler (Ticks & Text BELOW frame)
            if (range > 0) {
                ctx.strokeStyle = rulerTick;
                ctx.fillStyle = rulerText;
                ctx.font = '10px sans-serif';

                const startTick = Math.ceil(min / 100) * 100;

                for (let f = startTick; f <= max; f += 100) {
                    const pct = (f - min) / range;
                    if (pct < 0 || pct > 1) continue;

                    const x = pct * w;

                    // Draw Tick (Connecting frame to text)
                    ctx.beginPath();
                    ctx.moveTo(x, frameH);     // Start at bottom of frame
                    ctx.lineTo(x, frameH + 6); // Draw 6px down
                    ctx.stroke();

                    // --- ALIGNMENT LOGIC ---
                    // If at start (0%), align Left
                    // If at end (100%), align Right
                    // Otherwise, Center
                    if (Math.abs(pct) < 0.001) {
                        ctx.textAlign = 'left';
                    } else if (Math.abs(pct - 1) < 0.001) {
                        ctx.textAlign = 'right';
                    } else {
                        ctx.textAlign = 'center';
                    }

                    // Draw Text
                    ctx.fillText(f, x, textY);
                }
            }

            // 3. Draw Center Baseline (Inside Frame)
            ctx.strokeStyle = baselineColor; 
            ctx.lineWidth = 2; 
            ctx.beginPath(); 
            ctx.moveTo(0, frameH/2); 
            ctx.lineTo(w, frameH/2); 
            ctx.stroke();

            // 4. Draw VTX1 Markers (Blue - Above Baseline)
            ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--vtx1-color').trim();
            vtx1Freqs.forEach(f => {
                if(f < min || f > max) return;
                const x = (f - min) / range * w;
                ctx.beginPath(); 
                ctx.moveTo(x, frameH/2 - 4); 
                ctx.lineTo(x - 5, frameH/2 - 14); 
                ctx.lineTo(x + 5, frameH/2 - 14); 
                ctx.fill();
            });

            // 5. Draw VTX2 Markers (Green - Below Baseline)
            ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--vtx2-color').trim();
            vtx2Freqs.forEach(f => {
                if(f < min || f > max) return;
                const x = (f - min) / range * w;
                ctx.beginPath(); 
                ctx.moveTo(x, frameH/2 + 4); 
                ctx.lineTo(x - 5, frameH/2 + 14); 
                ctx.lineTo(x + 5, frameH/2 + 14); 
                ctx.fill();
            });
        }

        // Mapping Logic for Click Interaction
        function getFreqFromX(x) {
            const min = parseInt(vrxMinInput.value) || 4200;
            const max = parseInt(vrxMaxInput.value) || 4900;
            const drawW = vizContainer.offsetWidth; // No margin substraction
            let pct = x / drawW;
            return Math.round(min + (Math.max(0, Math.min(1, pct)) * (max - min)));
        }

        // Canvas Interactions
        canvas.addEventListener('mousemove', (e) => {
            if(isPopupOpen) return;
            const rect = canvas.getBoundingClientRect();
            const freq = getFreqFromX(e.clientX - rect.left);
            freqPopup.style.display = 'block';
            freqPopup.style.left = (e.clientX - rect.left) + 'px';
            freqPopup.style.top = '10px'; 
            popupLabel.textContent = freq;
            popupVtx1.style.display = 'none'; popupVtx2.style.display = 'none';
        });
        canvas.addEventListener('mouseleave', () => { if(!isPopupOpen) freqPopup.style.display = 'none'; });
        canvas.addEventListener('click', (e) => {
            const rect = canvas.getBoundingClientRect();
            selectedFreq = getFreqFromX(e.clientX - rect.left);
            isPopupOpen = true;
            freqPopup.style.display = 'block';
            freqPopup.style.left = (e.clientX - rect.left) + 'px';
            freqPopup.style.top = '0px'; 
            popupLabel.textContent = selectedFreq;
            popupVtx1.style.display = 'inline-block'; popupVtx2.style.display = 'inline-block';
            if(vtx1Freqs.includes(selectedFreq)) popupVtx1.classList.add('active'); else popupVtx1.classList.remove('active');
            if(vtx2Freqs.includes(selectedFreq)) popupVtx2.classList.add('active'); else popupVtx2.classList.remove('active');
        });
        document.addEventListener('click', (e) => {
            if(e.target !== canvas && !freqPopup.contains(e.target)) { isPopupOpen = false; freqPopup.style.display = 'none'; }
        });
        
        function toggleFreq(vtxNum) {
            let list = (vtxNum === 1) ? vtx1Freqs : vtx2Freqs;
            const idx = list.indexOf(selectedFreq);
            if(idx > -1) list.splice(idx, 1); else list.push(selectedFreq);
            updateVtxDisplay(vtxNum);
            if(vtxNum===1) popupVtx1.classList.toggle('active'); else popupVtx2.classList.toggle('active');
            drawViz();
            updateCliTextarea();
        }
        popupVtx1.addEventListener('click', () => toggleFreq(1));
        popupVtx2.addEventListener('click', () => toggleFreq(2));
        
        writeCaretBtn.addEventListener('click', (e) => { e.stopPropagation(); resetRow.classList.toggle('show'); });
        document.addEventListener('click', () => resetRow.classList.remove('show'));
        readBtn.addEventListener('click', async () => {
            await readAllSettings();
        });
        resetBtn.addEventListener('click', (e) => { 
            e.stopPropagation();
            resetRow.classList.remove('show'); 
            log("Reset not implemented"); 
        });

        // --- 9. RANDOM GENERATOR POPUP ---
        function createRandPopupIfNeeded() {
            if (randPopup) return;

            // Overlay
            randOverlay = document.createElement('div');
            randOverlay.className = 'overlay';
            document.body.appendChild(randOverlay);

            // Popup
            randPopup = document.createElement('div');
            randPopup.className = 'rand-popup';
            randPopup.innerHTML = `
                <div class="rand-header">
                    <span>Generate VTX channels</span>
                    <button class="btn-blue" id="randCloseBtn" style="background:#999;">✕</button>
                </div>
                <div class="rand-body">
                    <div class="rand-row">
                        <label>Mode:</label>
                        <div class="grow">
                            <label><input type="radio" name="randMode" id="randModeAdd" value="add" checked> Add</label>
                            <label style="margin-left:16px;"><input type="radio" name="randMode" id="randModeReplace" value="replace"> Replace</label>
                        </div>
                    </div>
                    <div class="rand-row">
                        <label>Target:</label>
                        <div class="grow">
                            <label><input type="radio" name="randTarget" id="randTargetV1" value="v1"> VTX1</label>
                            <label style="margin-left:16px;"><input type="radio" name="randTarget" id="randTargetV2" value="v2"> VTX2</label>
                            <label style="margin-left:16px;"><input type="radio" name="randTarget" id="randTargetBoth" value="both" checked> Both</label>
                        </div>
                    </div>
                    <div class="rand-row" style="align-items:flex-start;">
                        <label>I got harmonics on:</label>
                        <div class="grow">
                            <textarea id="randExcl" class="rand-textarea" placeholder="Examples: 4444-4500  4444..4500  4444...4500  4444 4445 4446\nAlso supported: 4444 to 4500, 4444—4500 (dash), comma/space separated."></textarea>
                        </div>
                    </div>
                    <div class="rand-row">
                        <label>Number of channels:</label>
                        <div class="grow">
                            <input id="randCount" type="number" min="4" max="99" step="1" inputmode="numeric" pattern="[0-9]*" placeholder="4-99" />
                        </div>
                    </div>
                </div>
                <div class="rand-footer">
                    <button class="btn-blue" id="randFillBtn">Fill</button>
                </div>
            `;
            document.body.appendChild(randPopup);

            // Hook controls
            randModeAdd = randPopup.querySelector('#randModeAdd');
            randModeReplace = randPopup.querySelector('#randModeReplace');
            randExcl = randPopup.querySelector('#randExcl');
            randCount = randPopup.querySelector('#randCount');
            randTargetV1 = randPopup.querySelector('#randTargetV1');
            randTargetV2 = randPopup.querySelector('#randTargetV2');
            randTargetBoth = randPopup.querySelector('#randTargetBoth');
            randFillBtn = randPopup.querySelector('#randFillBtn');
            randCloseBtn = randPopup.querySelector('#randCloseBtn');

            randCloseBtn.addEventListener('click', closeRandPopup);
            randOverlay.addEventListener('click', closeRandPopup);
            document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeRandPopup(); });
            randCount.addEventListener('input', () => {
                // clamp between 4 and 99
                let v = parseInt(randCount.value, 10);
                if (Number.isNaN(v)) return;
                if (v < 4) v = 4;
                if (v > 99) v = 99;
                randCount.value = v;
            });
            randFillBtn.addEventListener('click', onRandFill);
        }

        function openRandPopup() {
            createRandPopupIfNeeded();
            randOverlay.classList.add('show');
            randPopup.classList.add('show');
        }
        function closeRandPopup() {
            if (!randPopup) return;
            randOverlay.classList.remove('show');
            randPopup.classList.remove('show');
        }

        function parseExclusions(input, min, max) {
            const set = new Set();
            if (!input) return set;
            const tokens = input
                .replace(/[,;\n]+/g, ' ') // normalize separators
                .trim()
                .split(/\s+/);
            for (const t of tokens) {
                if (!t) continue;
                // Normalize range separators
                const norm = t.replace(/…|–|—/g, '-') // ellipsis/en/em dash to '-'
                              .replace(/\.{2,}/g, '-') // .. or ... to '-'
                              .toLowerCase();
                if (/^\d+\s*(to|-)+\s*\d+$/.test(norm)) {
                    const parts = norm.split(/to|-+/);
                    let a = parseInt(parts[0], 10), b = parseInt(parts[1], 10);
                    if (Number.isFinite(a) && Number.isFinite(b)) {
                        if (a > b) [a, b] = [b, a];
                        a = Math.max(a, min); b = Math.min(b, max);
                        for (let v = a; v <= b; v++) set.add(v);
                    }
                } else if (/^\d+$/.test(norm)) {
                    const v = parseInt(norm, 10);
                    if (v >= min && v <= max) set.add(v);
                }
                // Everything else ignored silently
            }
            return set;
        }

        function generateRandomNonAdjacent(count, min, max, excludeSet) {
            // Build pool of allowed freqs
            const pool = [];
            for (let v = min; v <= max; v++) {
                if (!excludeSet.has(v)) pool.push(v);
            }
            if (pool.length === 0) return [];
            // Shuffle pool for randomness
            for (let i = pool.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [pool[i], pool[j]] = [pool[j], pool[i]];
            }
            const picked = [];
            const pickedSet = new Set();
            for (const v of pool) {
                if (picked.length >= count) break;
                // avoid immediate neighbors (no consecutive values)
                if (pickedSet.has(v) || pickedSet.has(v - 1) || pickedSet.has(v + 1)) continue;
                picked.push(v);
                pickedSet.add(v);
            }
            // Keep randomized order (do not sort) to avoid "consecutive hundreds" visual effect
            return picked;
        }

        function unionUniquePreserve(a, b) {
            const seen = new Set();
            const out = [];
            function pushIfNew(x){ if(!seen.has(x)){ seen.add(x); out.push(x);} }
            a.forEach(pushIfNew);
            b.forEach(pushIfNew);
            return out;
        }

        function onRandFill() {
            const min = parseInt(vrxMinInput.value) || 0;
            const max = parseInt(vrxMaxInput.value) || 0;
            if (!(max > min)) { alert('Invalid VRX range'); return; }

            const excl = parseExclusions(randExcl.value, min, max);
            const desired = parseInt((randCount.value || '0'), 10) || 0;
            if (desired <= 0) { alert('Enter desired number of channels (positive number)'); return; }

            const list = generateRandomNonAdjacent(desired, min, max, excl);
            if (list.length === 0) { alert('No available frequencies to choose from. Adjust range/exclusions.'); return; }
            if (list.length < desired) {
                log(`Warning: Only ${list.length} non-consecutive channels available within range and exclusions (requested ${desired}).`);
            }

            const mode = randModeReplace.checked ? 'replace' : 'add';
            const applyTo = randTargetBoth && randTargetBoth.checked ? 'both' : (randTargetV2 && randTargetV2.checked ? 'v2' : 'v1');

            function applyToOne(which, srcList) {
                if (which === 'v1') {
                    if (mode === 'replace') vtx1Freqs = srcList.slice();
                    else vtx1Freqs = unionUniquePreserve(vtx1Freqs, srcList);
                    updateVtxDisplay(1);
                } else if (which === 'v2') {
                    if (mode === 'replace') vtx2Freqs = srcList.slice();
                    else vtx2Freqs = unionUniquePreserve(vtx2Freqs, srcList);
                    updateVtxDisplay(2);
                }
            }
            if (applyTo === 'both') {
                // Distribute almost evenly by alternating assignment
                const v1List = [];
                const v2List = [];
                list.forEach((v, i) => { (i % 2 === 0 ? v1List : v2List).push(v); });
                applyToOne('v1', v1List);
                applyToOne('v2', v2List);
            } else {
                applyToOne(applyTo, list);
            }

            drawViz();
            updateCliTextarea();
            closeRandPopup();
        }

        randBtn.addEventListener('click', (e) => {
            e.preventDefault();
            openRandPopup();
        });

        // --- 10a. HARMONICS MODAL (from intrmd.html) ---
        function createHarmModalIfNeeded() {
            if (harmPopup) return;
            // Overlay
            harmOverlay = document.createElement('div');
            harmOverlay.className = 'overlay';
            document.body.appendChild(harmOverlay);

            // Popup
            harmPopup = document.createElement('div');
            harmPopup.className = 'rand-popup';
            harmPopup.style.width = 'min(980px, 96vw)';
            harmPopup.innerHTML = `
                <div class=\"rand-header\">
                    <span>Intermodulation and harmonics calculator</span>
                    <button class=\"btn-blue\" id=\"harmCloseBtn\" style=\"background:#999;\">✕</button>
                </div>
                <div class=\"rand-body\">
                    <div class=\"harm-row\">
                        <label>Observation Window (MHz)</label>
                        <div class=\"harm-inputs\">
                            <div class=\"input-with-suffix compact\">
                                <input type=\"number\" id=\"harm_range_start\" value=\"900\"> 
                                <span class=\"suffix\">MHz</span>
                            </div>
                            <div class=\"input-with-suffix compact\">
                                <input type=\"number\" id=\"harm_range_end\" value=\"6000\"> 
                                <span class=\"suffix\">MHz</span>
                            </div>
                        </div>
                    </div>
                    <div class=\"harm-columns\">
                        <div class=\"harm-col\" id=\"harm_col1\" style=\"border-top:4px solid var(--vtx1-color);\"><h3>Intermod F1</h3></div>
                        <div class=\"harm-col\" id=\"harm_col2\" style=\"border-top:4px solid #6610f2;\"><h3>Intermod F2</h3></div>
                        <div class=\"harm-col\" id=\"harm_col3\" style=\"border-top:4px solid #fd7e14;\"><h3>Harmonics Only</h3></div>
                    </div>
                    <div class=\"harm-results\" id=\"harm_results\"></div>
                    <div class=\"rand-row\" style=\"align-items:flex-start; margin-top:8px;\">
                        <label style=\"width:auto;\">RAW FILTERED RANGES</label>
                        <div class=\"harm-raw grow\" id=\"harm_raw\"></div>
                    </div>
                </div>
                <div class=\"rand-footer\">
                    <button class=\"btn-blue\" id=\"harmCloseBtn2\">Close</button>
                </div>
            `;
            document.body.appendChild(harmPopup);

            // Element refs
            hRangeStart = harmPopup.querySelector('#harm_range_start');
            hRangeEnd = harmPopup.querySelector('#harm_range_end');
            hCol1 = harmPopup.querySelector('#harm_col1');
            hCol2 = harmPopup.querySelector('#harm_col2');
            hCol3 = harmPopup.querySelector('#harm_col3');
            hResults = harmPopup.querySelector('#harm_results');
            hRaw = harmPopup.querySelector('#harm_raw');

            // Build column headers with inputs and items containers
            if (hCol1) hCol1.innerHTML = `
                <div class="harm-col-header">
                    <h3>VTX1</h3>
                    <div class="input-with-suffix compact">
                        <input type="number" id="harm_c1_freq" class="harm-5ch" placeholder="freq">
                        <span class="suffix">MHz</span>
                    </div>
                    <div class="input-with-suffix compact">
                        <input type="number" id="harm_c1_bw" class="harm-3ch" placeholder="width">
                        <span class="suffix">MHz</span>
                    </div>
                    <button class="btn-green" id="harm_c1_add" title="Add">+</button>
                </div>
                <div class="harm-items" id="harm_col1_items"></div>`;
            if (hCol2) hCol2.innerHTML = `
                <div class="harm-col-header">
                    <h3>VTX2</h3>
                    <div class="input-with-suffix compact">
                        <input type="number" id="harm_c2_freq" class="harm-5ch" placeholder="freq">
                        <span class="suffix">MHz</span>
                    </div>
                    <div class="input-with-suffix compact">
                        <input type="number" id="harm_c2_bw" class="harm-3ch" placeholder="width">
                        <span class="suffix">MHz</span>
                    </div>
                    <button class="btn-green" id="harm_c2_add" title="Add">+</button>
                </div>
                <div class="harm-items" id="harm_col2_items"></div>`;
            if (hCol3) hCol3.innerHTML = `
                <div class="harm-col-header">
                    <h3>TX to FPV</h3>
                    <div class="input-with-suffix compact">
                        <input type="number" id="harm_c3_freq" class="harm-5ch" placeholder="freq">
                        <span class="suffix">MHz</span>
                    </div>
                    <div class="input-with-suffix compact">
                        <input type="number" id="harm_c3_bw" class="harm-3ch" placeholder="width">
                        <span class="suffix">MHz</span>
                    </div>
                    <button class="btn-green" id="harm_c3_add" title="Add">+</button>
                </div>
                <div class="harm-items" id="harm_col3_items"></div>`;

            // Query per-column inputs and items
            hC1Freq = harmPopup.querySelector('#harm_c1_freq');
            hC1Bw = harmPopup.querySelector('#harm_c1_bw');
            hC2Freq = harmPopup.querySelector('#harm_c2_freq');
            hC2Bw = harmPopup.querySelector('#harm_c2_bw');
            hC3Freq = harmPopup.querySelector('#harm_c3_freq');
            hC3Bw = harmPopup.querySelector('#harm_c3_bw');
            hCol1Items = harmPopup.querySelector('#harm_col1_items');
            hCol2Items = harmPopup.querySelector('#harm_col2_items');
            hCol3Items = harmPopup.querySelector('#harm_col3_items');

            // Hooks
            const harmCloseBtn = harmPopup.querySelector('#harmCloseBtn');
            const harmCloseBtn2 = harmPopup.querySelector('#harmCloseBtn2');
            harmCloseBtn.addEventListener('click', closeHarmModal);
            harmCloseBtn2.addEventListener('click', closeHarmModal);
            harmOverlay.addEventListener('click', closeHarmModal);
            document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeHarmModal(); });

            const add1 = harmPopup.querySelector('#harm_c1_add');
            const add2 = harmPopup.querySelector('#harm_c2_add');
            const add3 = harmPopup.querySelector('#harm_c3_add');
            if (add1) add1.addEventListener('click', () => { const f = parseFloat(hC1Freq.value); const b = parseFloat(hC1Bw.value); harmAddToCol(1, f, b); });
            if (add2) add2.addEventListener('click', () => { const f = parseFloat(hC2Freq.value); const b = parseFloat(hC2Bw.value); harmAddToCol(2, f, b); });
            if (add3) add3.addEventListener('click', () => { const f = parseFloat(hC3Freq.value); const b = parseFloat(hC3Bw.value); harmAddToCol(3, f, b); });

            hRangeStart.addEventListener('input', harmCalculateAll);
            hRangeEnd.addEventListener('input', harmCalculateAll);

            // Initial render
            harmRender();
        }

        function openHarmModal() {
            createHarmModalIfNeeded();
            harmOverlay.classList.add('show');
            harmPopup.classList.add('show');
        }
        function closeHarmModal() {
            if (!harmPopup) return;
            harmOverlay.classList.remove('show');
            harmPopup.classList.remove('show');
        }

        function harmAddToCol(n, f, b) {
            if (!Number.isFinite(f)) return;
            // Default widths when left empty: VTX1/VTX2 = 20 MHz, TX to FPV = 30 MHz
            const bw = Number.isFinite(b) ? b : (n === 3 ? 30 : 20);
            hLists[n-1].push({ id: Date.now() + Math.random(), freq: f, bw, active: false });
            // Clear the inputs for that column
            if (n === 1 && hC1Freq) { hC1Freq.value = ''; }
            if (n === 2 && hC2Freq) { hC2Freq.value = ''; }
            if (n === 3 && hC3Freq) { hC3Freq.value = ''; }
            harmRender();
        }

        function harmToggle(n, id) {
            const item = hLists[n-1].find(i => i.id === id);
            if (item) item.active = !item.active;
            harmRender();
        }

        function harmRemove(e, n, id) {
            e.stopPropagation();
            hLists[n-1] = hLists[n-1].filter(i => i.id !== id);
            harmRender();
        }

        function harmRender() {
            const colors = [getComputedStyle(document.documentElement).getPropertyValue('--vtx1-color').trim() || '#007bff', '#6610f2', '#fd7e14'];
            const containers = [hCol1Items, hCol2Items, hCol3Items];
            [1,2,3].forEach(num => {
                const itemsDiv = containers[num-1];
                if (!itemsDiv) return;
                itemsDiv.innerHTML = '';
                hLists[num-1].forEach(item => {
                    const div = document.createElement('div');
                    div.className = `harm-item ${item.active ? 'active' : ''}`;
                    div.style.color = item.active ? colors[num-1] : 'var(--muted-fg)';
                    div.onclick = () => harmToggle(num, item.id);
                    div.innerHTML = `<span><b>${item.freq}</b> <small>${item.bw || 0}MHz BW</small></span><button class=\"harm-del\" aria-label=\"Remove\" title=\"Remove\" onclick=\"event.stopPropagation(); window.__harmRemove(${num}, ${item.id})\">&times;</button>`;
                    itemsDiv.appendChild(div);
                });
            });
            // Expose remove handler for inline onclick
            window.__harmRemove = (n, id) => { hLists[n-1] = hLists[n-1].filter(i => i.id !== id); harmRender(); };
            harmCalculateAll();
        }

        function harmIntersects(s1,e1,s2,e2) { return Math.max(s1,s2) <= Math.min(e1,e2); }

        function mergeRanges(pairs) {
            if (!pairs || pairs.length === 0) return [];
            const arr = pairs
                .map(p => ({ s: Math.min(p[0], p[1]), e: Math.max(p[0], p[1]) }))
                .sort((a, b) => (a.s - b.s) || (a.e - b.e));
            const out = [arr[0]];
            for (let i = 1; i < arr.length; i++) {
                const last = out[out.length - 1];
                const cur = arr[i];
                // Merge intersecting ranges (overlap)
                if (cur.s <= last.e) {
                    last.e = Math.max(last.e, cur.e);
                } else {
                    out.push({ s: cur.s, e: cur.e });
                }
            }
            return out;
        }

        function harmCalculateAll() {
            const active1 = hLists[0].filter(i => i.active);
            const active2 = hLists[1].filter(i => i.active);
            const active3 = hLists[2].filter(i => i.active);
            const winS = parseFloat(hRangeStart.value);
            const winE = parseFloat(hRangeEnd.value);

            if (active1.length === 0 && active2.length === 0 && active3.length === 0) {
                hResults.style.display = 'none';
                hRaw.textContent = '';
                return;
            }

            let html = `<strong>Detected Products in Window (${winS}-${winE} MHz):</strong><br><br>`;
            let rawRanges = [];
            let found = false;

            // Intermod
            active1.forEach(o1 => {
                active2.forEach(o2 => {
                    const f1 = o1.freq, f2 = o2.freq; const bw1 = o1.bw||0, bw2 = o2.bw||0;
                    const products = [
                        { name: '3rd Order (2f1-f2)', c: Math.abs(2*f1-f2), w: (2*bw1)+bw2, cls: 'harm-order3' },
                        { name: '3rd Order (2f2-f1)', c: Math.abs(2*f2-f1), w: (2*bw2)+bw1, cls: 'harm-order3' },
                        { name: '2nd Order (f1+f2)', c: f1+f2, w: bw1+bw2, cls: 'harm-order2' },
                        { name: '2nd Order (f1-f2)', c: Math.abs(f1-f2), w: bw1+bw2, cls: 'harm-order2' }
                    ];
                    let mixHtml = '';
                    products.forEach(p => {
                        const start = p.c - p.w/2; const end = p.c + p.w/2;
                        if (harmIntersects(start,end,winS,winE)) {
                            mixHtml += `<div class=\"harm-im ${p.cls}\"><b>${p.name}</b><br><span class=\"range-text\">${start.toFixed(1)}-${end.toFixed(1)}</span></div>`;
                            rawRanges.push([Math.round(start), Math.round(end)]);
                        }
                    });
                    if (mixHtml) { found = true; html += `<div class=\"harm-res-row\"><strong>IM Mix: ${f1} & ${f2}</strong><br>${mixHtml}</div>`; }
                });
            });

            // Harmonics
            active3.forEach(o3 => {
                let harmHtml = '';
                for (let h = 2; h <= 10; h++) {
                    const center = o3.freq * h; const width = (o3.bw||0) * h;
                    const start = center - width/2; const end = center + width/2;
                    if (harmIntersects(start,end,winS,winE)) {
                        harmHtml += `<div class=\"harm-im harm-harmonic\"><b>${h}th Harmonic</b><br><span class=\"range-text\">${start.toFixed(1)}-${end.toFixed(1)}</span></div>`;
                        rawRanges.push([Math.round(start), Math.round(end)]);
                    }
                }
                if (harmHtml) { found = true; html += `<div class=\"harm-res-row\"><strong>Harmonics: ${o3.freq}</strong><br>${harmHtml}</div>`; }
            });

            hResults.innerHTML = found ? html : '<em>No active products fall within the observation window.</em>';
            hResults.style.display = 'block';
            const merged = mergeRanges(rawRanges);
            hRaw.textContent = merged.map(r => `${r.s}-${r.e}`).join(' ');
        }

        harmBtn.addEventListener('click', (e) => { e.preventDefault(); openHarmModal(); });

        // --- 10. HELP MODAL ---
        function createHelpModalIfNeeded() {
            if (helpPopup) return;
            // Overlay
            helpOverlay = document.createElement('div');
            helpOverlay.className = 'overlay';
            document.body.appendChild(helpOverlay);

            // Popup (reuse rand-popup styles)
            helpPopup = document.createElement('div');
            helpPopup.className = 'rand-popup';
            helpPopup.style.maxHeight = '80vh';
            helpPopup.style.overflow = 'hidden';
            helpPopup.innerHTML = `
                <div class="rand-header">
                    <span>Опис команд терміналу</span>
                    <button class="btn-blue" id="helpCloseBtn" style="background:#999;">✕</button>
                </div>
                <div class="rand-body" style="overflow:auto; max-height:calc(80vh - 110px);">
                    <div class="help-intro">
                        <p>Frodo для польотника як VTX на протоколі Tramp, але слухає лише команди потужності.</p>
                        <h4>Ролі</h4>
                        <ul>
                            <li><strong>Air unit (1)</strong> — почергово вмикає обидва VTX для безперервності відео.</li>
                            <li><strong>Ground unit (0)</strong> — у тій же послідовності перемикає VRX.</li>
                        </ul>
                        <p>Для синхронізації використовується <strong>Sync_channel AUX</strong> — обидва юніти мають отримати його одночасно, тому важливо не робити цього, коли зі зв'язком з дроном є проблеми. Реагує саме на <em>зміну</em> (не на фіксоване верхнє/нижнє значення).</p>
                        <p><strong>Stop</strong>: при значенні ≈2000 на відповідному AUX юніт зупиняє перемикання послідовності і потужносей!!! Щоб перемкнулась потужність поки що мають перемикатись частоти. Якщо юніти почули команду неодночасно й зупинилися на різних частотах — повторіть Start/Stop.</p>
                    </div>
                    <details open>
                        <summary><strong>help</strong></summary>
                        <p><em>Призначення</em><br>Команда відображає службову інформацію прошивки (commit) та повний список доступних команд CLI з короткими описами кожної.</p>
                        <p><em>Використання</em><br>Виконується без аргументів.<br>Приклад: <code>help</code></p>
                        <p><em>Результат</em><br>виводиться рядок типу <code>Commit c01aa72;</code> далі — перелік усіх команд (set_guard_time, set_role, set_tx_time, set_vtx1_freq тощо) та їх коротких описів.</p>
                    </details>
                    <details>
                        <summary><strong>set_guard_time</strong></summary>
                        <p><em>Призначення</em><br>Встановлює додатковий «запас» часу (safety buffer / paranoia), який додається до основного часу перемикання частоти.</p>
                        <p><em>Використання</em><br>Без аргументів — показує поточне значення: <code>set_guard_time</code><br>З аргументом (мс) — встановлює нове: <code>set_guard_time 30</code></p>
                        <p><em>Примітки</em><br>Типове значення — близько 20 мс. Занадто великий guard_time збільшує цикл хопінгу.</p>
                    </details>
                    <details>
                        <summary><strong>set_role</strong></summary>
                        <p><em>Призначення</em><br>Роль пристрою: ground або air.</p>
                        <p><em>Використання</em><br>Без аргументів — показ поточного значення: <code>set_role</code><br>З аргументом — встановлення: <code>set_role 0</code> (ground), <code>set_role 1</code> (air)</p>
                        <p><em>Примітки</em><br>Пара має бути налаштована як ground/air відповідно.</p>
                        <p>Нагадування про змінук ролі відновляться після перезавантаження сторінки.</p>
                    </details>
                    <details>
                        <summary><strong>set_stop_rc_channel</strong></summary>
                        <p><em>Призначення</em><br>Вибір RC‑каналу для команди «зупинки» хопінгу/передачі.</p>
                        <p><em>Використання</em><br>Показ: <code>set_stop_rc_channel</code><br>Встановлення: <code>set_stop_rc_channel 9</code></p>
                        <p><em>Примітки</em><br>Інтерпретація стану каналу залежить від прошивки.</p>
                    </details>
                    <details>
                        <summary><strong>set_sw_latency</strong></summary>
                        <p><em>Призначення</em><br>Задає апаратну затримку перемикання частоти (мс).</p>
                        <p><em>Використання</em><br>Показ: <code>set_sw_latency</code><br>Встановлення: <code>set_sw_latency 150</code></p>
                        <p><em>Примітки</em><br>Типово ~100 мс. Замале/завелике значення впливає на стабільність/швидкість хопінгу.</p>
                    </details>
                    <details>
                        <summary><strong>set_sync_rc_channel</strong></summary>
                        <p><em>Призначення</em><br>RC‑канал для синхронізації або додаткового керування режимом.</p>
                        <p><em>Використання</em><br>Показ: <code>set_sync_rc_channel</code><br>Встановлення: <code>set_sync_rc_channel 5</code></p>
                    </details>
                    <details>
                        <summary><strong>set_tx_time</strong></summary>
                        <p><em>Призначення</em><br>Тривалість перебування на частоті під час хопінгу (мс).</p>
                        <p><em>Використання</em><br>Показ: <code>set_tx_time</code><br>Встановлення: <code>set_tx_time 2500</code></p>
                        <p><em>Примітки</em><br>Мінімум: <code>sw_latency + guard_time</code>. Більший час — довші слоти, повільніший обхід.</p>
                    </details>
                    <details>
                        <summary><strong>set_vtx1_freq</strong></summary>
                        <p><em>Призначення</em><br>Список робочих частот для VTX1.</p>
                        <p><em>Використання</em><br>Показ: <code>set_vtx1_freq</code><br>Встановлення: <code>set_vtx1_freq 4200 4250 4300 ...</code></p>
                        <p><em>Примітки</em><br>Частоти мають бути у дозволеному діапазоні вашого VTX.</p>
                    </details>
                    <details>
                        <summary><strong>set_vtx2_freq</strong></summary>
                        <p><em>Призначення</em><br>Аналогічно до VTX1, але для VTX2.</p>
                        <p><em>Використання</em><br>Показ: <code>set_vtx2_freq</code><br>Встановлення: <code>set_vtx2_freq 4500 4550 4600 ...</code></p>
                    </details>
                </div>
                <div class="rand-footer">
                    <button class="btn-blue" id="helpCloseBtn2">Close</button>
                </div>
            `;
            document.body.appendChild(helpPopup);

            helpCloseBtn = helpPopup.querySelector('#helpCloseBtn');
            const helpCloseBtn2 = helpPopup.querySelector('#helpCloseBtn2');

            const close = () => closeHelpModal();
            helpCloseBtn.addEventListener('click', close);
            helpCloseBtn2.addEventListener('click', close);
            helpOverlay.addEventListener('click', close);
            document.addEventListener('keydown', (e) => { if (e.key === 'Escape') close(); });
        }

        function openHelpModal() {
            createHelpModalIfNeeded();
            helpOverlay.classList.add('show');
            helpPopup.classList.add('show');
        }
        function closeHelpModal() {
            if (!helpPopup) return;
            helpOverlay.classList.remove('show');
            helpPopup.classList.remove('show');
        }

        helpBtn.addEventListener('click', (e) => { e.preventDefault(); openHelpModal(); });

        // THEME HANDLING
        function applyTheme(mode) {
            const root = document.documentElement;
            if (mode === 'light') {
                root.setAttribute('data-theme', 'light');
            } else if (mode === 'dark') {
                root.setAttribute('data-theme', 'dark');
            } else {
                root.removeAttribute('data-theme');
            }
            const btn = document.getElementById('themeToggle');
            if (btn) btn.textContent = (mode === 'light' ? 'Light' : mode === 'dark' ? 'Dark' : 'Auto');
            drawViz();
        }
        function initTheme() {
            const saved = localStorage.getItem('frodo_theme') || 'auto';
            applyTheme(saved);
            const btn = document.getElementById('themeToggle');
            if (btn) btn.addEventListener('click', () => {
                const current = document.documentElement.getAttribute('data-theme') || 'auto';
                const next = current === 'auto' ? 'dark' : current === 'dark' ? 'light' : 'auto';
                localStorage.setItem('frodo_theme', next);
                applyTheme(next);
            });
        }

        // ROLE CHANGE CONFIRMATION
        async function getDeviceRole() {
            try {
                const txt = await sendCommandAndWait('set_role');
                const m = txt.match(/(\d+)/g);
                if (m && m.length) return parseInt(m[m.length - 1], 10);
            } catch (_) {}
            return null;
        }

        function createRoleConfirmIfNeeded() {
            if (roleConfirmPopup) return;
            roleConfirmOverlay = document.createElement('div');
            roleConfirmOverlay.className = 'overlay';
            document.body.appendChild(roleConfirmOverlay);

            roleConfirmPopup = document.createElement('div');
            roleConfirmPopup.className = 'rand-popup';
            roleConfirmPopup.innerHTML = `
                <div class="rand-header"><span>Confirm role change</span></div>
                <div class="rand-body">
                    <p id="roleConfirmText">Changing role...</p>
                </div>
                <div class="rand-footer" style="justify-content: space-between; align-items: center;">
                    <label style="display:flex; align-items:center; gap:6px; margin-right:auto; margin-left:4px;">
                        <input type="checkbox" id="roleConfirmDontAsk"> <span>Не нагадувати</span>
                    </label>
                    <div style="display:flex; gap:8px;">
                        <button id="roleConfirmCancel" style="background:#dc3545; color:#fff; border:none; border-radius:4px; padding:6px 12px; font-weight:600;">Cancel</button>
                        <button id="roleConfirmYes" style="background:#28a745; color:#fff; border:none; border-radius:4px; padding:6px 12px; font-weight:600;">Yes</button>
                    </div>
                </div>`;
            document.body.appendChild(roleConfirmPopup);

            roleConfirmText = roleConfirmPopup.querySelector('#roleConfirmText');
            roleConfirmYes = roleConfirmPopup.querySelector('#roleConfirmYes');
            roleConfirmCancel = roleConfirmPopup.querySelector('#roleConfirmCancel');
            roleConfirmDontAsk = roleConfirmPopup.querySelector('#roleConfirmDontAsk');
        }

        function showRoleConfirm(currentRole, desiredRole) {
            return new Promise(resolve => {
                createRoleConfirmIfNeeded();
                roleConfirmText.textContent = `Changing role from ${currentRole} to ${desiredRole}`;
                roleConfirmOverlay.classList.add('show');
                roleConfirmPopup.classList.add('show');
                const cleanup = () => {
                    roleConfirmOverlay.classList.remove('show');
                    roleConfirmPopup.classList.remove('show');
                };
                roleConfirmCancel.onclick = () => { cleanup(); resolve(false); };
                roleConfirmYes.onclick = () => { 
                    if (roleConfirmDontAsk && roleConfirmDontAsk.checked) suppressRoleChangeConfirm = true;
                    cleanup(); resolve(true);
                };
                const onEsc = (e) => { if (e.key === 'Escape') { document.removeEventListener('keydown', onEsc); cleanup(); resolve(false);} };
                document.addEventListener('keydown', onEsc);
                roleConfirmOverlay.onclick = () => { cleanup(); resolve(false); };
            });
        }

        async function ensureRoleChangeOk(desiredRole) {
            const current = await getDeviceRole();
            if (current === null || current === desiredRole) return true;
            return await showRoleConfirm(current, desiredRole);
        }
        // --- 9. CLI COMMANDS PANEL ---
        const cliTextarea = document.getElementById('cliTextarea');
        let cliProgrammatic = false;
        let cliParseTimer = null;
        let cliUserEditing = false;

        function getVrxRange() {
            const min = parseInt(vrxMinInput.value) || 0;
            const max = parseInt(vrxMaxInput.value) || 9999;
            return [min, max];
        }

        function buildCliCommands() {
            const cmds = [];
            cmds.push(`set_role ${roleSelect.value}`);
            cmds.push(`set_sync_rc_channel ${syncAuxSelect.value}`);
            cmds.push(`set_stop_rc_channel ${stopAuxSelect.value}`);
            if (swLatencyInput.value) cmds.push(`set_sw_latency ${swLatencyInput.value}`);
            if (txTimeInput.value) cmds.push(`set_tx_time ${txTimeInput.value}`);
            // Always include guard time as 20 (hidden from UI)
            cmds.push(`set_guard_time 20`);

            const [min, max] = getVrxRange();
            const validVtx1 = (vtx1Freqs || []).filter(f => f >= min && f <= max);
            const validVtx2 = (vtx2Freqs || []).filter(f => f >= min && f <= max);
            if (validVtx1.length > 0) cmds.push(`set_vtx1_freq ${validVtx1.join(' ')}`);
            if (validVtx2.length > 0) cmds.push(`set_vtx2_freq ${validVtx2.join(' ')}`);
            return cmds;
        }

        function updateCliTextarea() {
            if (!cliTextarea) return;
            cliProgrammatic = true;
            cliTextarea.value = buildCliCommands().join('\n');
            cliProgrammatic = false;
        }

        function getCommandsForWrite() {
            const allowed = [
                'set_role',
                'set_sync_rc_channel',
                'set_stop_rc_channel',
                'set_sw_latency',
                'set_tx_time',
                'set_vtx1_freq',
                'set_vtx2_freq',
                'set_guard_time'
            ];
            const lines = (cliTextarea?.value || '').split(/\r?\n/)
                .map(s => s.trim())
                .filter(Boolean)
                .filter(s => allowed.some(a => s.startsWith(a)));

            // Remove any custom guard time and enforce 20
            const filtered = lines.filter(l => !l.startsWith('set_guard_time'));
            filtered.push('set_guard_time 20');
            return filtered;
        }

        function parseCliTextarea() {
            const lines = cliTextarea.value.split(/\r?\n/).map(s => s.trim()).filter(Boolean);
            let newVtx1 = null, newVtx2 = null;
            for (const line of lines) {
                if (/^set_role\s+/.test(line)) {
                    const m = line.match(/^set_role\s+(\d+)/);
                    if (m) roleSelect.value = m[1];
                } else if (/^set_sync_rc_channel\s+/.test(line)) {
                    const m = line.match(/^set_sync_rc_channel\s+(\d+)/);
                    if (m) syncAuxSelect.value = m[1];
                } else if (/^set_stop_rc_channel\s+/.test(line)) {
                    const m = line.match(/^set_stop_rc_channel\s+(\d+)/);
                    if (m) stopAuxSelect.value = m[1];
                } else if (/^set_sw_latency\s+/.test(line)) {
                    const m = line.match(/^set_sw_latency\s+(\d+)/);
                    if (m) swLatencyInput.value = m[1];
                } else if (/^set_tx_time\s+/.test(line)) {
                    const m = line.match(/^set_tx_time\s+(\d+)/);
                    if (m) txTimeInput.value = m[1];
                } else if (/^set_vtx1_freq\s+/.test(line)) {
                    const nums = line.replace(/^set_vtx1_freq\s+/, '').trim().split(/\s+/).map(Number).filter(n => !isNaN(n));
                    newVtx1 = nums;
                } else if (/^set_vtx2_freq\s+/.test(line)) {
                    const nums = line.replace(/^set_vtx2_freq\s+/, '').trim().split(/\s+/).map(Number).filter(n => !isNaN(n));
                    newVtx2 = nums;
                }
                // set_guard_time is intentionally ignored in UI (fixed to 20)
            }
            // Enforce AUX distinctness after parsing CLI overrides
            ensureAuxDistinct();
            updateAuxDisables();
            if (newVtx1 !== null) vtx1Freqs = newVtx1;
            if (newVtx2 !== null) vtx2Freqs = newVtx2;
            updateVtxDisplay(1);
            updateVtxDisplay(2);
            drawViz();
        }

        // Keep CLI in sync when UI changes
        function maybeUpdateCli() { if (!cliUserEditing) updateCliTextarea(); }
        roleSelect.addEventListener('change', maybeUpdateCli);
        syncAuxSelect.addEventListener('change', maybeUpdateCli);
        stopAuxSelect.addEventListener('change', maybeUpdateCli);
        swLatencyInput.addEventListener('input', maybeUpdateCli);
        txTimeInput.addEventListener('input', maybeUpdateCli);

        cliTextarea.addEventListener('input', () => {
            if (cliProgrammatic) return;
            if (cliParseTimer) clearTimeout(cliParseTimer);
            cliParseTimer = setTimeout(() => {
                parseCliTextarea();
            }, 300);
        });

        cliTextarea.addEventListener('focus', () => { cliUserEditing = true; });
        cliTextarea.addEventListener('blur', () => { 
            cliUserEditing = false; 
            updateCliTextarea();
        });

        // Initialize CLI with current defaults
        updateCliTextarea();

    </script>
</body>
</html>
